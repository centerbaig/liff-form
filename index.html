<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Form</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Segoe UI,Tahoma;
      max-width:720px;
      margin:16px auto;
      padding:0 12px;
      background:#fff;
    }
    h2{margin:0 0 6px}
    .small{font-size:13px;color:#555;word-break:break-word}
    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:14px;
      margin:12px 0;
      overflow:hidden;
      background:#fff;
    }
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,button,textarea{
      width:100%;
      max-width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #ccc;
      font-size:16px;
    }
    textarea{min-height:72px;resize:vertical}
    button{border:none;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn{background:#0b57d0;color:#fff;margin-top:10px}
    .btn2{background:#111827;color:#fff;margin-top:10px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > div{flex:1;min-width:140px}

    img.preview{
      max-width:100%;
      border-radius:10px;
      margin-top:8px;
      border:1px solid #eee;
      display:none;
    }

    .ok{color:green;font-weight:700}
    .err{color:#b91c1c;font-weight:700}

    /* Popup modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(420px, 100%);
      background:#fff;
      border-radius:16px;
      padding:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
    }
    .modal h3{margin:0 0 6px;font-size:18px}
    .modal p{margin:0 0 12px;color:#444}
    .modal .actions{display:flex;gap:10px}
    .modal .actions button{width:100%}
  </style>
</head>

<body>
  <h2>ส่งข้อมูลหน้างาน</h2>
  <div class="small">แนบรูป 3 รูป + ดึงพิกัดอัตโนมัติ + แสดงที่อยู่ + ใส่ชื่อโครงการ (ไม่บังคับ) แล้วกดส่ง</div>

  <div class="card">
    <div><b>ผู้ส่ง:</b> <span id="who">กำลังโหลด...</span></div>
    <!-- ซ่อน UserID จาก UI (แต่ยังส่งไป backend ได้) -->
    <div class="small" id="uid" style="display:none"></div>
  </div>

  <div class="card">
    <label>ชื่อโครงการ (ไม่บังคับ)</label>
    <input id="projectName" placeholder="เช่น โครงการ ABC" />

    <div class="row">
      <div>
        <label>ละติจูด</label>
        <input id="lat" readonly placeholder="กำลังดึงพิกัด..." />
      </div>
      <div>
        <label>ลองจิจูด</label>
        <input id="lng" readonly placeholder="กำลังดึงพิกัด..." />
      </div>
    </div>

    <label>ที่อยู่ (อัตโนมัติจากพิกัด)</label>
    <textarea id="address" readonly placeholder="กำลังแปลงพิกัดเป็นที่อยู่..."></textarea>

    <button class="btn2" type="button" onclick="getLocation()">ดึงพิกัด/ที่อยู่อีกครั้ง</button>
    <div class="small" id="locMsg"></div>
  </div>

  <div class="card">
    <label>1) รูปหน้าบ้าน</label>
    <input type="file" id="img1" accept="image/*" capture="environment" />
    <img id="p1" class="preview" />

    <label>2) รูปบ้านเลขที่</label>
    <input type="file" id="img2" accept="image/*" capture="environment" />
    <img id="p2" class="preview" />

    <label>3) รูปป้ายประกาศ</label>
    <input type="file" id="img3" accept="image/*" capture="environment" />
    <img id="p3" class="preview" />

    <button class="btn" id="submitBtn" type="button" onclick="submitForm()">ส่งข้อมูล</button>
    <div id="result" class="small"></div>
  </div>

  <!-- Success Popup -->
  <div id="successModal" class="modal-backdrop">
    <div class="modal">
      <h3>ส่งข้อมูลสำเร็จ</h3>
      <p id="successMsg">ระบบบันทึกข้อมูลเรียบร้อยแล้ว</p>
      <div class="actions">
        <button class="btn" type="button" onclick="closeLiff()">ตกลง</button>
      </div>
    </div>
  </div>

<script>
  const LIFF_ID = "2009152302-xTk3ZrjV";
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycby8gbWx0N_DAy_FO4sPyiXREl08LeqJSWBNxazJZupssyYC-JhRC3qzDn8I-t_jMb26/exec";

  let profile = null;

  async function init() {
    const whoEl = document.getElementById("who");
    const uidEl = document.getElementById("uid");

    try {
      whoEl.textContent = "กำลังเริ่ม LIFF...";
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isInClient()) {
        whoEl.innerHTML = `<span class="err">ลิงก์นี้ต้องเปิดใน LINE เท่านั้น</span>`;
        return;
      }

      if (!liff.isLoggedIn()) {
        whoEl.textContent = "กำลังเข้าสู่ระบบ LINE...";
        liff.login();
        return;
      }

      profile = await liff.getProfile();
      whoEl.textContent = profile.displayName || "(ไม่มีชื่อ)";
      uidEl.textContent = profile.userId || "";

      bindPreview("img1","p1");
      bindPreview("img2","p2");
      bindPreview("img3","p3");

      // ดึงพิกัด + ที่อยู่ อัตโนมัติ
      getLocation();

    } catch (e) {
      whoEl.innerHTML = `<span class="err">LIFF error: ${e.message || e}</span>`;
      console.error(e);
    }
  }

  function bindPreview(inputId, imgId) {
    const input = document.getElementById(inputId);
    const img = document.getElementById(imgId);
    input.addEventListener("change", () => {
      if (!input.files || !input.files[0]) return;
      const url = URL.createObjectURL(input.files[0]);
      img.src = url;
      img.style.display = "block";
    });
  }

  async function reverseToAddress(lat, lng) {
    // ใส่ t กัน cache
    const url = `${BACKEND_URL}?action=reverse&lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&t=${Date.now()}`;
    const res = await fetch(url);
    return await res.json();
  }

  function getLocation() {
    const msg = document.getElementById("locMsg");
    const addrEl = document.getElementById("address");

    msg.textContent = "กำลังขอพิกัด...";
    addrEl.value = "";

    if (!navigator.geolocation) {
      msg.innerHTML = `<span class="err">อุปกรณ์/บราวเซอร์ไม่รองรับการดึงพิกัด</span>`;
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        document.getElementById("lat").value = lat;
        document.getElementById("lng").value = lng;

        msg.innerHTML = `<span class="ok">ได้พิกัดแล้ว กำลังแปลงเป็นที่อยู่...</span>`;
        addrEl.placeholder = "กำลังแปลงพิกัดเป็นที่อยู่...";

        try {
          const j = await reverseToAddress(lat, lng);
          if (j.ok) {
            addrEl.value = j.address || "";
            msg.innerHTML = `<span class="ok">ได้พิกัดและที่อยู่แล้ว</span>`;
          } else {
            msg.innerHTML = `<span class="err">แปลงที่อยู่ไม่สำเร็จ: ${j.error || ""}</span>`;
          }
        } catch (e) {
          msg.innerHTML = `<span class="err">เรียกบริการแปลงที่อยู่ไม่สำเร็จ</span>`;
        }
      },
      (err) => {
        let extra = "";
        if (err.code === 1) extra = " (ไม่ได้อนุญาต Location ให้ LINE/เว็บนี้)";
        if (err.code === 2) extra = " (หาสัญญาณ GPS ไม่เจอ ลองออกไปที่โล่ง/เปิด GPS)";
        if (err.code === 3) extra = " (Timeout ลองใหม่อีกครั้ง)";
        msg.innerHTML = `<span class="err">ดึงพิกัดไม่สำเร็จ: ${err.message}${extra}</span>`;
      },
      { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
    );
  }

  function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function submitForm() {
    const result = document.getElementById("result");
    const btn = document.getElementById("submitBtn");
    result.textContent = "กำลังส่งข้อมูล...";
    btn.disabled = true;

    try {
      if (!profile || !profile.userId) {
        throw new Error("ยังดึงโปรไฟล์ LINE ไม่สำเร็จ กรุณาปิดแล้วเปิดจาก Rich Menu อีกครั้ง");
      }

      const projectName = document.getElementById("projectName").value.trim() || "";
      const lat = document.getElementById("lat").value;
      const lng = document.getElementById("lng").value;
      const address = document.getElementById("address").value || "";

      const f1 = document.getElementById("img1").files[0];
      const f2 = document.getElementById("img2").files[0];
      const f3 = document.getElementById("img3").files[0];

      if (!lat || !lng) throw new Error("กรุณาดึงพิกัดก่อน (หรือรอให้ดึงอัตโนมัติสำเร็จ)");
      if (!f1 || !f2 || !f3) throw new Error("กรุณาแนบรูปให้ครบ 3 รูป");

      const [d1, d2, d3] = await Promise.all([
        fileToDataUrl(f1),
        fileToDataUrl(f2),
        fileToDataUrl(f3),
      ]);

      const payload = {
        projectName,
        latitude: Number(lat),
        longitude: Number(lng),
        address,
        lineUserId: profile.userId,
        lineDisplayName: profile.displayName,
        linePictureUrl: profile.pictureUrl || "",
        images: [
          { label: "front_house", dataUrl: d1 },
          { label: "house_no", dataUrl: d2 },
          { label: "notice_sign", dataUrl: d3 },
        ]
      };

      // สำคัญ: ไม่ใส่ headers Content-Type เพื่อเลี่ยง preflight
      const res = await fetch(BACKEND_URL, {
        method: "POST",
        body: JSON.stringify(payload),
      });

      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "ส่งไม่สำเร็จ");

      result.textContent = "";
      showSuccessModal("ระบบบันทึกข้อมูลเรียบร้อยแล้ว กดตกลงเพื่อปิดหน้าจอ");

    } catch (e) {
      result.innerHTML = `<span class="err">${e.message || e}</span>`;
      btn.disabled = false;
    }
  }

  function showSuccessModal(message) {
    const modal = document.getElementById("successModal");
    const msgEl = document.getElementById("successMsg");
    msgEl.textContent = message || "ระบบบันทึกข้อมูลเรียบร้อยแล้ว";
    modal.style.display = "flex";
  }

  function closeLiff() {
    if (typeof liff !== "undefined" && liff.isInClient && liff.isInClient()) {
      liff.closeWindow();
    } else {
      window.close();
    }
  }

  init();
</script>
</body>
</html>
