<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Vision Test</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Tahoma;max-width:680px;margin:16px auto;padding:0 12px}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;margin:12px 0}
    label{display:block;margin:10px 0 6px;font-weight:700}
    input,button{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;font-size:16px}
    button{border:none;cursor:pointer;background:#0b57d0;color:#fff;margin-top:10px}
    button:disabled{opacity:.6;cursor:not-allowed}
    img{max-width:100%;border-radius:10px;margin-top:10px;border:1px solid #eee;display:none}
    .small{font-size:13px;color:#555;word-break:break-word}
    .ok{color:green;font-weight:700}
    .err{color:#b91c1c;font-weight:700}
    pre{background:#111827;color:#fff;padding:10px;border-radius:10px;overflow:auto}
  </style>
</head>
<body>
  <h2>ทดสอบอ่านรูป (Vision Test)</h2>
  <div class="small">เลือก “รูปป้ายประกาศ” 1 รูป แล้วส่งไปหลังบ้าน เพื่อให้ Make ดาวน์โหลดจาก Drive ด้วย fileId และส่งเข้า OpenAI Vision</div>

  <div class="card">
    <div><b>ผู้ส่ง:</b> <span id="who">กำลังโหลด...</span></div>
    <div class="small"><b>userId:</b> <span id="uid">(รอ…)</span></div>
  </div>

  <div class="card">
    <label>รูปป้ายประกาศ (Required)</label>
    <input type="file" id="img" accept="image/*" capture="environment" />
    <img id="preview" />

    <button id="btn" type="button" onclick="submitForm()">ส่งเพื่อทดสอบ</button>
    <div id="msg" class="small"></div>
    <div class="small">Debug response:</div>
    <pre id="debug"></pre>
  </div>

<script>
  const LIFF_ID = "2009152302-xTk3ZrjV";
  // ✅ เปลี่ยนเป็น URL ของ Web App (Vision Test) ที่ Deploy จาก Code.gs ด้านล่าง
  const BACKEND_URL = "PASTE_YOUR_VISION_TEST_WEBAPP_URL_HERE";

  let profile = null;

  function bindPreview() {
    const input = document.getElementById("img");
    const img = document.getElementById("preview");
    input.addEventListener("change", () => {
      if (!input.files || !input.files[0]) { img.style.display="none"; return; }
      img.src = URL.createObjectURL(input.files[0]);
      img.style.display = "block";
    });
  }

  async function resizeImageToDataUrl(file, maxSide = 1280, quality = 0.75) {
    const bitmap = await createImageBitmap(file);
    const scale = Math.min(1, maxSide / Math.max(bitmap.width, bitmap.height));
    const nw = Math.round(bitmap.width * scale);
    const nh = Math.round(bitmap.height * scale);

    const canvas = document.createElement("canvas");
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(bitmap, 0, 0, nw, nh);

    return canvas.toDataURL("image/jpeg", quality);
  }

  async function submitForm() {
    const msg = document.getElementById("msg");
    const debug = document.getElementById("debug");
    const btn = document.getElementById("btn");
    msg.textContent = "";
    debug.textContent = "";
    btn.disabled = true;

    try {
      const f = document.getElementById("img").files[0];
      if (!f) throw new Error("กรุณาเลือกรูปก่อน");

      if (!profile || !profile.userId) {
        throw new Error("ยังดึงโปรไฟล์ LINE ไม่สำเร็จ กรุณาเปิดจากใน LINE อีกครั้ง");
      }

      const dataUrl = await resizeImageToDataUrl(f, 1280, 0.75);

      // ✅ ส่งเฉพาะที่จำเป็นสำหรับ Vision Test
      const payload = {
        lineUserId: profile.userId,
        lineDisplayName: profile.displayName || "",
        images: [
          { label: "notice_sign", dataUrl }
        ]
      };

      const res = await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" }, // ✅ สำคัญ
        body: JSON.stringify(payload),
      });

      const json = await res.json();
      debug.textContent = JSON.stringify(json, null, 2);

      if (!json.ok) throw new Error(json.error || "ส่งไม่สำเร็จ");

      msg.innerHTML = `<span class="ok">ส่งสำเร็จ — ตรวจที่ Make ได้เลย</span>`;
    } catch (e) {
      msg.innerHTML = `<span class="err">${e.message || e}</span>`;
    } finally {
      btn.disabled = false;
    }
  }

  async function init() {
    const whoEl = document.getElementById("who");
    try {
      whoEl.textContent = "กำลังเริ่ม LIFF...";
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isInClient()) {
        whoEl.innerHTML = `<span class="err">ลิงก์นี้ต้องเปิดใน LINE เท่านั้น</span>`;
        return;
      }
      if (!liff.isLoggedIn()) {
        whoEl.textContent = "กำลังเข้าสู่ระบบ LINE...";
        liff.login();
        return;
      }

      profile = await liff.getProfile();
      whoEl.textContent = profile.displayName || "(ไม่มีชื่อ)";
      document.getElementById("uid").textContent = profile.userId || "-";

      bindPreview();
    } catch (e) {
      whoEl.innerHTML = `<span class="err">LIFF error: ${e.message || e}</span>`;
      console.error(e);
    }
  }

  init();
</script>
</body>
</html>
