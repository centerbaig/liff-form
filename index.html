<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Form</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Segoe UI,Tahoma;
      max-width:720px;
      margin:16px auto;
      padding:0 12px;
      background:#fff;
    }
    h2{margin:0 0 6px}
    .small{font-size:13px;color:#555;word-break:break-word}
    .card{
      border:1px solid #ddd;
      border-radius:12px;
      padding:14px;
      margin:12px 0;
      overflow:hidden;
      background:#fff;
    }
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,button,select{
      width:100%;
      max-width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #ccc;
      font-size:16px;
      background:#fff;
    }
    button{border:none;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}

    .btn{background:#0b57d0;color:#fff;margin-top:10px}
    .btn2{background:#111827;color:#fff}
    .btnGhost{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > div{flex:1;min-width:140px}

    .preview{
      max-width:100%;
      border-radius:10px;
      margin-top:8px;
      border:1px solid #eee;
      display:none;
    }

    .ok{color:green;font-weight:700}
    .err{color:#b91c1c;font-weight:700}

    .pick{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 6px}
    .pick button{flex:1;min-width:140px}

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(420px, 100%);
      background:#fff;
      border-radius:16px;
      padding:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
    }
    .modal h3{margin:0 0 6px;font-size:18px}
    .modal p{margin:0 0 12px;color:#444}
    .modal .actions{display:flex;gap:10px}
    .modal .actions button{width:100%}

    .progressWrap{margin-top:8px}
    .progressBar{
      width:100%;
      height:10px;
      background:#eee;
      border-radius:999px;
      overflow:hidden;
    }
    .progressFill{
      width:0%;
      height:100%;
      background:#0b57d0;
      border-radius:999px;
      transition: width .15s linear;
    }
  </style>
</head>

<body>
  <h2>ส่งข้อมูลหน้างาน</h2>
  <div class="small">แนบรูป (หน้าบ้าน + ป้ายประกาศ) • รูปบ้านเลขที่ไม่บังคับ • ดึงพิกัดอัตโนมัติ • แล้วกดส่ง</div>

  <div class="card">
    <div><b>ผู้ส่ง:</b> <span id="who">กำลังโหลด...</span></div>
    <div id="uid" style="display:none"></div>
  </div>

  <div class="card">
    <label>ชื่อโครงการ (ไม่บังคับ)</label>
    <input id="projectName" placeholder="เช่น โครงการ ABC" />

    <label>บ้านเลขที่</label>
    <input id="houseText" placeholder="เช่น 223/1" />

    <label>ประเภททรัพย์ <span class="err">*</span></label>
    <select id="assetType">
      <option value="">กรุณาระบุ</option>
      <option value="บ้านเดี่ยว">บ้านเดี่ยว</option>
      <option value="บ้านแฝด">บ้านแฝด</option>
      <option value="ที่ดิน">ที่ดิน</option>
    </select>

    <div class="row">
      <div>
        <label>ละติจูด</label>
        <input id="lat" readonly placeholder="กำลังดึงพิกัด..." />
      </div>
      <div>
        <label>ลองจิจูด</label>
        <input id="lng" readonly placeholder="กำลังดึงพิกัด..." />
      </div>
    </div>

    <button class="btnGhost" type="button" id="locBtn" onclick="getLocation()">ดึงพิกัดอีกครั้ง</button>
    <div class="small" id="locMsg"></div>
  </div>

  <div class="card">
    <label>1) รูปหน้าบ้าน <span class="err">*</span></label>
    <div class="pick">
      <button class="btn2" type="button" id="btn1cam">ถ่ายรูป</button>
      <button class="btnGhost" type="button" id="btn1lib">เลือกรูป</button>
    </div>
    <input type="file" id="img1_cam" accept="image/*" capture="environment" style="display:none" />
    <input type="file" id="img1_lib" accept="image/*" style="display:none" />
    <img id="p1" class="preview" />

    <label>3) รูปป้ายประกาศ <span class="err">*</span></label>
    <div class="pick">
      <button class="btn2" type="button" id="btn3cam">ถ่ายรูป</button>
      <button class="btnGhost" type="button" id="btn3lib">เลือกรูป</button>
    </div>
    <input type="file" id="img3_cam" accept="image/*" capture="environment" style="display:none" />
    <input type="file" id="img3_lib" accept="image/*" style="display:none" />
    <img id="p3" class="preview" />

    <label>2) รูปบ้านเลขที่ (ไม่บังคับ)</label>
    <div class="pick">
      <button class="btn2" type="button" id="btn2cam">ถ่ายรูป</button>
      <button class="btnGhost" type="button" id="btn2lib">เลือกรูป</button>
    </div>
    <input type="file" id="img2_cam" accept="image/*" capture="environment" style="display:none" />
    <input type="file" id="img2_lib" accept="image/*" style="display:none" />
    <img id="p2" class="preview" />

    <button class="btn" id="submitBtn" type="button" onclick="submitForm()">ส่งข้อมูล</button>
    <div id="result" class="small"></div>
  </div>

  <!-- Sending Popup -->
  <div id="sendingModal" class="modal-backdrop">
    <div class="modal">
      <h3>กำลังส่งข้อมูล</h3>
      <p id="sendingMsg">กำลังส่งข้อมูลไปยังระบบ...</p>
      <div class="small"><b id="sendingPct">0%</b></div>
      <div class="progressWrap">
        <div class="progressBar"><div class="progressFill" id="sendingFill"></div></div>
      </div>
    </div>
  </div>

  <!-- Success Popup -->
  <div id="successModal" class="modal-backdrop">
    <div class="modal">
      <h3>ส่งข้อมูลสำเร็จ</h3>
      <p id="successMsg">ระบบบันทึกข้อมูลเรียบร้อยแล้ว</p>
      <div class="actions">
        <button class="btn" type="button" onclick="closeLiff()">ตกลง</button>
      </div>
    </div>
  </div>

<script>
  const LIFF_ID = "2009152302-xTk3ZrjV";
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycby8gbWx0N_DAy_FO4sPyiXREl08LeqJSWBNxazJZupssyYC-JhRC3qzDn8I-t_jMb26/exec";

  // ✅ resize config
  const MAX_SIDE = 1024;     // ตามที่คุณขอ
  const JPEG_QUALITY = 0.72; // ลดนิดนึงให้ไวขึ้น (ปรับได้)

  let profile = null;

  let fileFront = null;
  let fileHouseNo = null; // optional
  let fileSign = null;

  function showSending(show=true, msg="กำลังส่งข้อมูลไปยังระบบ...", pct=0){
    const modal = document.getElementById("sendingModal");
    const msgEl = document.getElementById("sendingMsg");
    const pctEl = document.getElementById("sendingPct");
    const fill  = document.getElementById("sendingFill");

    msgEl.textContent = msg;

    const p = Math.max(0, Math.min(100, Number(pct) || 0));
    pctEl.textContent = `${Math.round(p)}%`;
    fill.style.width = `${p}%`;

    modal.style.display = show ? "flex" : "none";
  }

  function showSuccessModal(message){
    const modal = document.getElementById("successModal");
    const msgEl = document.getElementById("successMsg");
    msgEl.textContent = message || "ระบบบันทึกข้อมูลเรียบร้อยแล้ว";
    modal.style.display = "flex";
  }

  function closeLiff(){
    if (typeof liff !== "undefined" && liff.isInClient && liff.isInClient()){
      liff.closeWindow();
    } else {
      window.close();
    }
  }

  function focusTo(el, msg){
    if (!el) return;
    el.scrollIntoView({behavior:"smooth", block:"center"});
    setTimeout(() => { try{ el.focus({preventScroll:true}); } catch(e){ try{el.focus();}catch(_){}} }, 250);

    const prev = el.style.borderColor;
    el.style.borderColor = "#b91c1c";
    el.style.boxShadow = "0 0 0 3px rgba(185,28,28,.15)";
    setTimeout(() => {
      el.style.borderColor = prev || "#ccc";
      el.style.boxShadow = "";
    }, 2200);

    if (msg){
      const result = document.getElementById("result");
      if (result) result.innerHTML = `<span class="err">${msg}</span>`;
    }
  }

  function bindDualPicker(camId, libId, previewId, setFile){
    const cam = document.getElementById(camId);
    const lib = document.getElementById(libId);
    const img = document.getElementById(previewId);

    function onPick(input){
      if (!input.files || !input.files[0]) return;
      const f = input.files[0];
      setFile(f);

      img.src = URL.createObjectURL(f);
      img.style.display = "block";

      if (input === cam) lib.value = "";
      if (input === lib) cam.value = "";
    }
    cam.addEventListener("change", () => onPick(cam));
    lib.addEventListener("change", () => onPick(lib));
  }

  function setupPickButtons(){
    document.getElementById("btn1cam").onclick = () => document.getElementById("img1_cam").click();
    document.getElementById("btn1lib").onclick = () => document.getElementById("img1_lib").click();

    document.getElementById("btn2cam").onclick = () => document.getElementById("img2_cam").click();
    document.getElementById("btn2lib").onclick = () => document.getElementById("img2_lib").click();

    document.getElementById("btn3cam").onclick = () => document.getElementById("img3_cam").click();
    document.getElementById("btn3lib").onclick = () => document.getElementById("img3_lib").click();
  }

  function getLocation(){
    const msg = document.getElementById("locMsg");
    msg.textContent = "กำลังขอพิกัด...";

    if (!navigator.geolocation){
      msg.innerHTML = `<span class="err">อุปกรณ์/บราวเซอร์ไม่รองรับการดึงพิกัด</span>`;
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        document.getElementById("lat").value = pos.coords.latitude;
        document.getElementById("lng").value = pos.coords.longitude;
        msg.innerHTML = `<span class="ok">ได้พิกัดแล้ว</span>`;
      },
      (err) => {
        let extra = "";
        if (err.code === 1) extra = " (ไม่ได้อนุญาต Location ให้ LINE/เว็บนี้)";
        if (err.code === 2) extra = " (หาสัญญาณ GPS ไม่เจอ ลองออกไปที่โล่ง/เปิด GPS)";
        if (err.code === 3) extra = " (Timeout ลองใหม่อีกครั้ง)";
        msg.innerHTML = `<span class="err">ดึงพิกัดไม่สำเร็จ: ${err.message}${extra}</span>`;
      },
      { enableHighAccuracy:true, timeout:20000, maximumAge:0 }
    );
  }

  function fileToDataUrl(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ✅ resize/compress เป็น JPEG (maxSide=1024)
  async function fileToJpegDataUrlResized(file, maxSide=1024, quality=0.72){
    const src = await fileToDataUrl(file);

    const img = await new Promise((resolve, reject) => {
      const im = new Image();
      im.onload = () => resolve(im);
      im.onerror = reject;
      im.src = src;
    });

    let w = img.width, h = img.height;
    const longer = Math.max(w, h);
    if (longer > maxSide){
      const scale = maxSide / longer;
      w = Math.round(w * scale);
      h = Math.round(h * scale);
    }

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    // บังคับเป็น jpeg เสมอ
    return canvas.toDataURL("image/jpeg", quality);
  }

  // ✅ POST + progress จริง + ตรวจ status
  function postJsonWithProgress(url, payload, onPct){
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open("POST", url, true);

      // กันค้าง (ปรับได้)
      xhr.timeout = 60000;

      xhr.upload.onprogress = (evt) => {
        if (!evt.lengthComputable) return;
        const pct = (evt.loaded / evt.total) * 100;
        onPct?.(pct);
      };

      xhr.onload = () => {
        // ถ้าไม่ใช่ 200 ให้ถือว่า error
        if (xhr.status < 200 || xhr.status >= 300) {
          reject(new Error(`HTTP ${xhr.status}: ${xhr.responseText || "Request failed"}`));
          return;
        }
        try {
          resolve(JSON.parse(xhr.responseText || "{}"));
        } catch (e) {
          reject(new Error("Response is not JSON"));
        }
      };

      xhr.ontimeout = () => reject(new Error("Request timeout"));
      xhr.onerror = () => reject(new Error("Network error"));

      // ❗ ไม่ตั้ง Content-Type เพื่อเลี่ยง preflight (คงแบบที่คุณทำไว้)
      xhr.send(JSON.stringify(payload));
    });
  }

  async function init(){
    const whoEl = document.getElementById("who");

    try{
      whoEl.textContent = "กำลังเริ่ม LIFF...";
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isInClient()){
        whoEl.innerHTML = `<span class="err">ลิงก์นี้ต้องเปิดใน LINE เท่านั้น</span>`;
        return;
      }
      if (!liff.isLoggedIn()){
        whoEl.textContent = "กำลังเข้าสู่ระบบ LINE...";
        liff.login();
        return;
      }

      profile = await liff.getProfile();
      whoEl.textContent = profile.displayName || "(ไม่มีชื่อ)";
      document.getElementById("uid").textContent = profile.userId || "";

      setupPickButtons();
      bindDualPicker("img1_cam","img1_lib","p1",(f)=>fileFront=f);
      bindDualPicker("img2_cam","img2_lib","p2",(f)=>fileHouseNo=f);
      bindDualPicker("img3_cam","img3_lib","p3",(f)=>fileSign=f);

      getLocation();

    }catch(e){
      whoEl.innerHTML = `<span class="err">LIFF error: ${e.message || e}</span>`;
      console.error(e);
    }
  }

  async function submitForm(){
    const result = document.getElementById("result");
    const btn = document.getElementById("submitBtn");
    result.textContent = "";
    btn.disabled = true;

    try{
      if (!profile || !profile.userId){
        btn.disabled = false;
        throw new Error("ยังดึงโปรไฟล์ LINE ไม่สำเร็จ กรุณาปิดแล้วเปิดจาก Rich Menu อีกครั้ง");
      }

      const projectEl = document.getElementById("projectName");
      const houseEl   = document.getElementById("houseText");
      const typeEl    = document.getElementById("assetType");
      const latEl     = document.getElementById("lat");
      const lngEl     = document.getElementById("lng");

      const assetType = typeEl.value;
      const lat = latEl.value;
      const lng = lngEl.value;

      if (!assetType){
        btn.disabled = false;
        focusTo(typeEl, "กรุณาเลือกประเภททรัพย์");
        return;
      }
      if (!lat || !lng){
        btn.disabled = false;
        focusTo(document.getElementById("locBtn"), "กรุณาดึงพิกัดก่อน (หรือรอให้ดึงอัตโนมัติสำเร็จ)");
        return;
      }
      if (!fileFront){
        btn.disabled = false;
        focusTo(document.getElementById("btn1cam"), "กรุณาแนบรูปหน้าบ้าน");
        return;
      }
      if (!fileSign){
        btn.disabled = false;
        focusTo(document.getElementById("btn3cam"), "กรุณาแนบรูปป้ายประกาศ");
        return;
      }

      showSending(true, "กำลังส่งข้อมูลไปยังระบบ...", 0);

      const projectName = projectEl.value.trim() || "";
      const houseText   = houseEl.value.trim() || "";

      // เตรียมรูป (0–60)
      showSending(true, "กำลังส่งข้อมูลไปยังระบบ...", 5);

      const images = [];
      const d1 = await fileToJpegDataUrlResized(fileFront, MAX_SIDE, JPEG_QUALITY);
      images.push({ label:"front_house", dataUrl:d1 });
      showSending(true, "กำลังส่งข้อมูลไปยังระบบ...", 25);

      if (fileHouseNo){
        const d2 = await fileToJpegDataUrlResized(fileHouseNo, MAX_SIDE, JPEG_QUALITY);
        images.push({ label:"house_no", dataUrl:d2 });
      }
      showSending(true, "กำลังส่งข้อมูลไปยังระบบ...", 45);

      const d3 = await fileToJpegDataUrlResized(fileSign, MAX_SIDE, JPEG_QUALITY);
      images.push({ label:"notice_sign", dataUrl:d3 });
      showSending(true, "กำลังส่งข้อมูลไปยังระบบ...", 60);

      const payload = {
        projectName,
        houseText,
        assetType,
        latitude: Number(lat),
        longitude: Number(lng),
        lineUserId: profile.userId,
        lineDisplayName: profile.displayName,
        images
      };

      // ส่งจริง (60–95)
      const json = await postJsonWithProgress(BACKEND_URL, payload, (uploadPct) => {
        const pct = 60 + (uploadPct * 0.35);
        showSending(true, "กำลังส่งข้อมูลไปยังระบบ...", pct);
      });

      showSending(true, "กำลังส่งข้อมูลไปยังระบบ...", 100);

      if (!json.ok) throw new Error(json.error || "ส่งไม่สำเร็จ");

      showSending(false);
      showSuccessModal("ระบบบันทึกข้อมูลเรียบร้อยแล้ว กดตกลงเพื่อปิดหน้าจอ");

    }catch(e){
      showSending(false);
      result.innerHTML = `<span class="err">${e.message || e}</span>`;
      btn.disabled = false;
    }
  }

  init();
</script>
</body>
</html>
